version: 1
metadata:
    name: ProperTea - Enrollment
entries:
    # -----------------------------------------------------------------------
    # Policies
    # -----------------------------------------------------------------------
    - model: authentik_policies_password.passwordpolicy
      id: propertea-policy-strict-password
      identifiers:
          name: ProperTea - Password policy
      attrs:
          length_min: 12
          check_have_i_been_pwned: true
          hibp_allowed_count: 0
          check_zxcvbn: true
          error_message: "Password must be at least 12 characters and not appear in known data breaches."

    # -----------------------------------------------------------------------
    # Form Fields
    # -----------------------------------------------------------------------
    -   model: authentik_stages_prompt.prompt
        id: propertea-prompt-field-username
        identifiers:
            field_key: username
        attrs:
            label: Username
            type: hidden
            required: true
            order: 0
            placeholder: "{{ request.context.prompt_data.email }}"
            placeholder_expression: true

    - model: authentik_stages_prompt.prompt
      id: propertea-prompt-field-email
      identifiers:
          field_key: email
      attrs:
          label: Email
          type: email
          required: true
          order: 10

    - model: authentik_stages_prompt.prompt
      id: propertea-prompt-field-name
      identifiers:
          field_key: name
      attrs:
          label: Full Name
          type: text
          required: true
          order: 20

    - model: authentik_stages_prompt.prompt
      id: propertea-prompt-field-password
      identifiers:
          field_key: password
      attrs:
          label: Password
          type: password
          required: true
          order: 30

    - model: authentik_stages_prompt.prompt
      id: propertea-prompt-field-password-repeat
      identifiers:
          field_key: password_repeat
      attrs:
          label: Repeat Password
          type: password
          required: true
          order: 40

    # -----------------------------------------------------------------------
    # Stages
    # -----------------------------------------------------------------------
    - model: authentik_stages_prompt.promptstage
      id: propertea-stage-enrollment-prompt
      identifiers:
          name: ProperTea - Enrollment Prompt
      attrs:
          fields:
              - !KeyOf propertea-prompt-field-username
              - !KeyOf propertea-prompt-field-name
              - !KeyOf propertea-prompt-field-email
              - !KeyOf propertea-prompt-field-password
              - !KeyOf propertea-prompt-field-password-repeat
          validation_policies:
              - !KeyOf propertea-policy-strict-password

    - model: authentik_stages_user_write.userwritestage
      id: propertea-stage-user-write
      identifiers:
          name: ProperTea - Create User
      attrs:
          create_users_as_inactive: false
          user_creation_mode: always_create

    - model: authentik_stages_user_login.userloginstage
      id: propertea-stage-user-login
      identifiers:
          name: ProperTea - Immediate Login

    # -----------------------------------------------------------------------
    # The Flow
    # -----------------------------------------------------------------------
    - model: authentik_flows.flow
      id: propertea-flow-enrollment
      identifiers:
          slug: propertea-enrollment
      attrs:
          name: ProperTea Sign Up
          title: Sign up for ProperTea
          designation: enrollment

    # -----------------------------------------------------------------------
    # Flow Bindings
    # -----------------------------------------------------------------------
    - model: authentik_flows.flowstagebinding
      id: propertea-binding-prompt
      identifiers:
          target: !KeyOf propertea-flow-enrollment
          stage: !KeyOf propertea-stage-enrollment-prompt
          order: 10
      attrs:
          invalid_response_action: retry

    - model: authentik_flows.flowstagebinding
      id: propertea-binding-user-write
      identifiers:
          target: !KeyOf propertea-flow-enrollment
          stage: !KeyOf propertea-stage-user-write
          order: 20

    - model: authentik_flows.flowstagebinding
      id: propertea-binding-user-login
      identifiers:
          target: !KeyOf propertea-flow-enrollment
          stage: !KeyOf propertea-stage-user-login
          order: 30
