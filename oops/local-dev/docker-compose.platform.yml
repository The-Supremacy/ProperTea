services:
    # --- Secrets Management ---
    infisical:
        image: infisical/infisical:v0.154.6
        container_name: propertea-infisical
        restart: unless-stopped
        depends_on:
            infra-postgres:
                condition: service_healthy
            infra-redis:
                condition: service_healthy
        environment:
            ENCRYPTION_KEY: ${INFISICAL_ENCRYPTION_KEY}
            AUTH_SECRET: ${INFISICAL_AUTH_SECRET}
            DB_CONNECTION_URI: "postgres://infisical:${INFISICAL_DB_PASS}@infra-postgres:5432/infisical"
            REDIS_URL: "redis://:${INFRA_REDIS_PASS}@infra-redis:6379"
            TELEMETRY_ENABLED: "false"
            SMTP_HOST: "propertea-mailpit"
            SMTP_PORT: 1025
            SMTP_USERNAME: "test"
            SMTP_PASSWORD: "test"
            SMTP_FROM_ADDRESS: "no-reply@propertea.local"
            SMTP_SECURE: "false"
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.infisical.rule=Host(`secrets.${DOMAIN_ROOT}`)"
            - "traefik.http.routers.infisical.tls=true"
            - "traefik.http.services.infisical.loadbalancer.server.port=8080"
        networks:
            - propertea-net

    # --- Feature Flags ---
    unleash:
        image: unleashorg/unleash-server:7.4.0
        container_name: propertea-unleash
        restart: unless-stopped
        depends_on:
            infra-postgres:
                condition: service_healthy
        environment:
            DATABASE_HOST: infra-postgres
            DATABASE_NAME: unleash
            DATABASE_USERNAME: unleash
            DATABASE_PASSWORD: ${UNLEASH_DB_PASS}
            DATABASE_SSL: "false"
            INIT_ADMIN_API_TOKEN: ${UNLEASH_INIT_ADMIN_API_TOKEN}
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.unleash.rule=Host(`flags.${DOMAIN_ROOT}`)"
            - "traefik.http.routers.unleash.tls=true"
            - "traefik.http.services.unleash.loadbalancer.server.port=4242"
        networks:
            - propertea-net

    # --- AuthZ ---
    openfga-migrate:
        image: openfga/openfga:v1.11.2
        container_name: propertea-openfga-migrate
        command: migrate
        depends_on:
            infra-postgres:
                condition: service_healthy
        environment:
            OPENFGA_DATASTORE_ENGINE: postgres
            OPENFGA_DATASTORE_URI: postgres://openfga:${OPENFGA_DB_PASS}@infra-postgres:5432/openfga?sslmode=disable
        networks:
            - propertea-net

    openfga:
        image: openfga/openfga:v1.11.2
        container_name: propertea-openfga
        restart: unless-stopped
        command: run
        depends_on:
            infra-postgres:
                condition: service_healthy
            openfga-migrate:
                condition: service_completed_successfully
        ports:
            - "3000:3000"
        environment:
            OPENFGA_DATASTORE_ENGINE: postgres
            OPENFGA_DATASTORE_URI: postgres://openfga:${OPENFGA_DB_PASS}@infra-postgres:5432/openfga?sslmode=disable
            OPENFGA_PLAYGROUND_ENABLED: "true"
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.openfga.rule=Host(`fga.${DOMAIN_ROOT}`)"
            - "traefik.http.routers.openfga.tls=true"
            - "traefik.http.services.openfga.loadbalancer.server.port=8080"
        networks:
            - propertea-net

    # --- Identity Provider ---
    zitadel:
        image: ghcr.io/zitadel/zitadel:v4.7.6
        container_name: propertea-zitadel
        restart: unless-stopped
        command: 'start-from-init --masterkeyFromEnv --tlsMode external'
        depends_on:
            infra-postgres:
                condition: service_healthy
        environment:
            - ZITADEL_DATABASE_POSTGRES_HOST=infra-postgres
            - ZITADEL_DATABASE_POSTGRES_PORT=5432
            - ZITADEL_DATABASE_POSTGRES_DATABASE=zitadel
            - ZITADEL_DATABASE_POSTGRES_USER_USERNAME=zitadel
            - ZITADEL_DATABASE_POSTGRES_USER_PASSWORD=${ZITADEL_DB_PASS}
            - ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE=disable
            - ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME=${INFRA_PG_USER}
            - ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD=${INFRA_PG_PASS}
            - ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE=disable

            - ZITADEL_EXTERNALSECURE=true
            - ZITADEL_EXTERNALDOMAIN=auth.${DOMAIN_ROOT}
            - ZITADEL_EXTERNALPORT=443
            - ZITADEL_TLS_ENABLED=false
            - ZITADEL_MASTERKEY=${ZITADEL_MASTERKEY}

            - ZITADEL_FIRSTINSTANCE_ORG_NAME=${ZITADEL_FIRSTINSTANCE_ORG_NAME}
            - ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME=${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME}
            - ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD=${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD}
            - ZITADEL_FIRSTINSTANCE_ORG_HUMAN_EMAIL=${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_EMAIL}
            - ZITADEL_FIRSTINSTANCE_ORG_HUMAN_FIRSTNAME=${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_FIRSTNAME}
            - ZITADEL_FIRSTINSTANCE_ORG_HUMAN_LASTNAME=${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_LASTNAME}
            - ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED=false
            - ZITADEL_FIRSTINSTANCE_ORG_HUMAN_EMAIL_VERIFIED=true
            - ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED=false
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.zitadel.rule=Host(`auth.${DOMAIN_ROOT}`)"
            - "traefik.http.routers.zitadel.tls=true"
            - "traefik.http.services.zitadel.loadbalancer.server.port=8080"
        networks:
            - propertea-net

volumes:
    authentik_media:
    authentik_templates:

networks:
    propertea-net:
