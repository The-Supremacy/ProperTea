# SIT environment ClusterIssuer: Let's Encrypt via Cloudflare DNS-01.
#
# Prerequisites:
#   1. Create a Cloudflare API token (Zone:DNS:Edit, Zone:Zone:Read) for your domain.
#   2. Encrypt it with SOPS and store as environments/sit/cert-manager/cloudflare-secret.enc.yaml
#      (ArgoCD's SOPS CMP sidecar decrypts it at sync time).
#   3. Update `email:` below to your real email address.
#   4. Once tested with staging, switch the ACME server URL to the production one.
#
# The Secret referenced below (cloudflare-api-token) is expected in cert-manager namespace.
# Create and encrypt it:
#   kubectl create secret generic cloudflare-api-token \
#     --namespace cert-manager \
#     --from-literal=api-token=<your-token> \
#     --dry-run=client -o yaml > cloudflare-secret.yaml
#   sops --encrypt --in-place cloudflare-secret.yaml
#   mv cloudflare-secret.yaml environments/sit/cert-manager/cloudflare-secret.enc.yaml
#
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-cloudflare
spec:
  acme:
    # Staging: safe for testing -- certs are not trusted by browsers but rate
    # limits are relaxed. Switch to production URL when ready:
    # https://acme-v02.api.letsencrypt.org/directory
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: admin@propertea.io  # UPDATE: replace with your real email
    privateKeySecretRef:
      name: letsencrypt-cloudflare-key
    solvers:
      - dns01:
          cloudflare:
            apiTokenSecretRef:
              name: cloudflare-api-token
              key: api-token
