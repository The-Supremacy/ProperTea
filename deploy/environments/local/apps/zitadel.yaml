apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: zitadel
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "7"
spec:
  project: default
  sources:
    - repoURL: https://charts.zitadel.com
      chart: zitadel
      targetRevision: 9.23.0
      helm:
        releaseName: zitadel
        valueFiles:
          - $values/deploy/infrastructure/base/zitadel/values.yaml
          - $values/deploy/environments/local/zitadel/values.yaml
    - repoURL: git@github.com:The-Supremacy/ProperTea.git
      targetRevision: HEAD
      ref: values
    - repoURL: git@github.com:The-Supremacy/ProperTea.git
      targetRevision: HEAD
      path: deploy/environments/local/zitadel-route

  destination:
    server: https://kubernetes.default.svc
    namespace: zitadel
  syncPolicy:
    # zitadel-masterkey is created automatically by the InfisicalSecret CR (wave 6,
    # zitadel-config). The InfisicalSecret operator syncs the masterkey from Infisical
    # into the zitadel namespace as a K8s Secret before this wave runs.
    #
    # Bootstrap sequence after initial cluster setup:
    #   1. Wave 5 (infisical + secrets-operator) syncs -- Infisical UI available
    #   2. Log in at https://infisical.local, create org/project, add masterkey secret,
    #      create Machine Identity, copy clientId + clientSecret
    #   3. Update infisical-machine-identity.enc.yaml with real credentials:
    #        sops deploy/environments/local/zitadel/infisical-machine-identity.enc.yaml
    #   4. Update projectSlug in infisical-secret.yaml, commit + push
    #   5. Wave 6 (zitadel-config) re-syncs -- InfisicalSecret creates zitadel-masterkey
    #   6. Wave 7 (this app) auto-syncs with the masterkey present
    automated:
      enabled: true
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true