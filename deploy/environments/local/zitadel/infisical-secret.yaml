# InfisicalSecret syncs the zitadel-masterkey from Infisical into the zitadel namespace.
#
# Bootstrap sequence:
#   1. After wave 5 (infisical) is healthy, log in at https://infisical.local and:
#      a. Create an organisation + project (e.g. slug: "propertea")
#      b. Add a secret: key=masterkey, value=<32-char random string> in env "local", path "/"
#      c. Create a Machine Identity with universal auth scoped to that project
#      d. Copy the client ID and client secret
#   2. Update the SOPS-encrypted machine identity placeholder:
#        cd deploy/environments/local/zitadel
#        sops --decrypt infisical-machine-identity.enc.yaml > /tmp/mid.yaml
#        # Edit /tmp/mid.yaml -- replace PLACEHOLDER values
#        sops --encrypt /tmp/mid.yaml > infisical-machine-identity.enc.yaml
#        rm /tmp/mid.yaml
#   3. Update projectSlug below to match what you created in Infisical
#   4. Commit and push -- zitadel-config (wave 6) will re-sync and create zitadel-masterkey
#   5. Wave 7 (zitadel) will auto-sync and find the masterkey secret ready
apiVersion: secrets.infisical.com/v1alpha1
kind: InfisicalSecret
metadata:
  name: zitadel-masterkey-sync
  namespace: zitadel
  labels:
    app.kubernetes.io/part-of: propertea
spec:
  # Internal K8s service URL -- no TLS configuration needed.
  hostAPI: http://infisical.infisical.svc.cluster.local:8080/api
  authentication:
    universalAuth:
      secretsScope:
        # Set this to the project slug you created in the Infisical UI.
        projectSlug: "propertea-local"
        envSlug: "local"
        secretsPath: "/"
        recursive: false
      credentialsRef:
        secretName: infisical-machine-identity
        secretNamespace: zitadel
  managedSecretReference:
    secretName: zitadel-masterkey
    secretNamespace: zitadel
    secretType: Opaque
    # Orphan: the K8s Secret survives deletion of this CR (prevents accidental data loss).
    creationPolicy: Orphan
    secretMapping:
    - infisicalKey: MASTERKEY
      secretKey: masterkey
