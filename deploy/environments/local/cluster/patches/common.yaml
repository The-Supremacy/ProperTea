# Common Talos machine config patch applied to ALL nodes (CP + workers).
# Configures: Cilium CNI (skip default), DNS, NTP, installer image, kubelet.

# Skip default Flannel CNI -- we install Cilium manually after bootstrap
cluster:
  network:
    cni:
      name: none
  proxy:
    disabled: true  # Cilium replaces kube-proxy

machine:
  network:
    nameservers:
      - 1.1.1.1
      - 8.8.8.8
  time:
    servers:
      - time.cloudflare.com
      - pool.ntp.org
  # Pin installer to the schematic image that includes iscsi-tools and util-linux-tools.
  # Without this, Talos installs the generic image to disk during bootstrap, losing extensions
  # on the first reboot even though the ISO had them. Keep SCHEMATIC and VERSION in sync
  # with Step 3 of the cluster README whenever either is bumped.
  install:
    image: factory.talos.dev/installer/613e1592b2da41ae5e265e8789429f22e121aab91cb4deb6bc3c0b6262961245:v1.12.4
  kubelet:
    extraArgs:
      rotate-server-certificates: "true"
    # Required by Longhorn: provides host directory access for volume data path.
    # See: https://longhorn.io/docs/1.8.1/advanced-resources/os-distro-specific/talos-linux-support/
    extraMounts:
      - destination: /var/lib/longhorn
        type: bind
        source: /var/lib/longhorn
        options:
          - bind
          - rshared
          - rw
