fullnameOverride: grafana

adminUser: admin
adminPassword: "Password1!"

# Grafana plugins installed at container startup.
# victoriametrics-datasource adds MetricsQL support and a richer metric browser.
# Dashboards built against the VictoriaMetrics plugin use type=victoriametrics-datasource.
# Our datasource is still type=prometheus (compatible); the plugin extends the UI only.
plugins:
  - victoriametrics-datasource

persistence:
  enabled: true
  storageClass: longhorn
  size: 2Gi
  accessModes:
    - ReadWriteOnce

resources:
  requests:
    memory: 128Mi
    cpu: 100m
  limits:
    memory: 512Mi
    cpu: 500m

# Pre-wire datasources so they are available immediately after deployment.
# UIDs are pinned so that cross-datasource links (trace→logs, trace→metrics) work.
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: VictoriaMetrics
        uid: victoriametrics
        type: prometheus
        url: http://victoria-metrics-server.o11y.svc.cluster.local:8428
        isDefault: true
        jsonData:
          httpMethod: POST
          timeInterval: 15s

      - name: Loki
        uid: loki
        type: loki
        url: http://loki.o11y.svc.cluster.local:3100
        jsonData:
          derivedFields:
            - name: TraceID
              matcherRegex: '"traceId":"(\w+)"'
              url: "$${__value.raw}"
              datasourceUid: tempo

      - name: Tempo
        uid: tempo
        type: tempo
        url: http://tempo.o11y.svc.cluster.local:3200
        jsonData:
          httpMethod: GET
          # Grafana's internal apiserver probes Tempo over gRPC (HTTP/2).
          # Without this flag it gets "frame too large" errors because Tempo's
          # port 3200 speaks HTTP/1.1, not gRPC.
          grpcAllowInsecure: true
          serviceMap:
            datasourceUid: victoriametrics
          tracesToMetrics:
            datasourceUid: victoriametrics
            tags:
              - key: service.name
                alias: service
          tracesToLogs:
            datasourceUid: loki
            filterByTraceID: true
          search:
            hide: false
          lokiSearch:
            datasourceUid: loki

sidecar:
  dashboards:
    enabled: true
    label: grafana_dashboard
    labelValue: "1"
    searchNamespace: ALL
  datasources:
    enabled: false  # datasources above are static, no sidecar needed

grafana.ini:
  server:
    root_url: https://grafana.local
  security:
    # Fixed key so sessions survive pod restarts. Without this, every restart
    # generates a new random key, invalidating all browser cookies and causing
    # a POST /api/user/auth-tokens/rotate → 499 spam loop.
    secret_key: "ProperTeaGrafanaLocalDev-ChangeThisOnProd-32chrMin"
  analytics:
    reporting_enabled: false
    check_for_updates: false
  users:
    allow_sign_up: false

# The chart validates that secret_key is not set in plain grafana.ini values.
# This flag disables that client-side assertion (acceptable for local dev;
# on prod the key should come from an ExternalSecret instead).
assertNoLeakedSecrets: false
