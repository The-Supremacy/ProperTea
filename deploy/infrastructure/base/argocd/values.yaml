# ArgoCD Helm values for ProperTea — environment-agnostic base.
#
# Key additions over defaults:
#   - SOPS CMP sidecar on repo-server: decrypts *.enc.yaml files before
#     running helm template. Only activates for apps that have *.enc.yaml files.
#   - Plugin config in extraObjects below (no separate pre-apply step needed).
#   - age private key mounted from argocd-age-key K8s secret (bootstrapped manually
#     by install-argocd.sh and not managed by this Helm release).
#
# Environment-specific values (e.g. domain) live in:
#   deploy/environments/<env>/argocd-values.yaml

configs:
  params:
    server.insecure: "true"

  # Custom health checks for CRDs that ArgoCD cannot assess natively.
  #
  # CNPG Cluster: ArgoCD considers the CR "Healthy" the moment the API server accepts it,
  # which is before any DB pod has started. This Lua check gates on readyInstances == instances,
  # preventing downstream waves (e.g. keycloak) from starting before the DB is truly ready.
  cm:
    resource.customizations: |
      cert-manager.io/Certificate:
        health.lua: |
          hs = {}
          if obj.status == nil or obj.status.conditions == nil then
            hs.status = "Progressing"
            hs.message = "Waiting for certificate status"
            return hs
          end
          for _, c in ipairs(obj.status.conditions) do
            if c.type == "Ready" then
              if c.status == "True" then
                hs.status = "Healthy"
                hs.message = "Certificate is ready"
              else
                hs.status = "Progressing"
                hs.message = c.message or "Certificate not yet ready"
              end
              return hs
            end
          end
          hs.status = "Progressing"
          hs.message = "Waiting for Ready condition"
          return hs
      cert-manager.io/ClusterIssuer:
        health.lua: |
          hs = {}
          if obj.status == nil or obj.status.conditions == nil then
            hs.status = "Progressing"
            hs.message = "Waiting for issuer status"
            return hs
          end
          for _, c in ipairs(obj.status.conditions) do
            if c.type == "Ready" then
              if c.status == "True" then
                hs.status = "Healthy"
                hs.message = "Issuer is ready"
              else
                hs.status = "Progressing"
                hs.message = c.message or "Issuer not yet ready"
              end
              return hs
            end
          end
          hs.status = "Progressing"
          hs.message = "Waiting for Ready condition"
          return hs
      postgresql.cnpg.io/Cluster:
        health.lua: |
          hs = {}
          if obj.status == nil then
            hs.status = "Progressing"
            hs.message = "Waiting for CNPG cluster status"
            return hs
          end
          local ready = obj.status.readyInstances or 0
          local total = obj.status.instances or 0
          if total > 0 and ready == total then
            hs.status = "Healthy"
            hs.message = ready .. "/" .. total .. " instances ready"
          else
            hs.status = "Progressing"
            hs.message = (ready or 0) .. "/" .. (total or "?") .. " instances ready"
          end
          return hs

repoServer:
  volumes:
    - name: custom-tools
      emptyDir: {}
    - name: cmp-helm-sops-config
      configMap:
        name: cmp-helm-sops-config
    - name: age-key
      secret:
        secretName: argocd-age-key
        optional: true

  initContainers:
    - name: download-tools
      image: alpine:3.21
      command:
        - sh
        - -c
        - |
          set -e
          SOPS_VERSION="v3.12.1"
          AGE_VERSION="v1.3.1"
          KUSTOMIZE_VERSION="v5.8.1"

          echo "Downloading sops ${SOPS_VERSION}..."
          wget -qO /custom-tools/sops \
            "https://github.com/getsops/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux.amd64"
          chmod +x /custom-tools/sops

          echo "Downloading age ${AGE_VERSION}..."
          wget -qO /tmp/age.tar.gz \
            "https://github.com/FiloSottile/age/releases/download/${AGE_VERSION}/age-${AGE_VERSION}-linux-amd64.tar.gz"
          tar -xzf /tmp/age.tar.gz -C /tmp
          cp /tmp/age/age /custom-tools/age
          chmod +x /custom-tools/age

          echo "Downloading kustomize ${KUSTOMIZE_VERSION}..."
          wget -qO /tmp/kustomize.tar.gz \
            "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${KUSTOMIZE_VERSION}/kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          tar -xzf /tmp/kustomize.tar.gz -C /custom-tools
          chmod +x /custom-tools/kustomize

          echo "Done."
          /custom-tools/sops --version
          /custom-tools/age --version
          /custom-tools/kustomize version
      volumeMounts:
        - mountPath: /custom-tools
          name: custom-tools

  # CMP sidecar: runs argocd-cmp-server, has helm + sops + age available
  extraContainers:
    - name: cmp-helm-sops
      command: [/var/run/argocd/argocd-cmp-server]
      image: alpine/helm:3.17.0
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
      env:
        - name: SOPS_AGE_KEY_FILE
          value: /age/key.txt
      volumeMounts:
        - mountPath: /var/run/argocd
          name: var-files
        - mountPath: /home/argocd/cmp-server/plugins
          name: plugins
        - mountPath: /home/argocd/cmp-server/config
          name: cmp-helm-sops-config
        - mountPath: /tmp
          name: tmp
        - mountPath: /usr/local/bin/sops
          name: custom-tools
          subPath: sops
        - mountPath: /usr/local/bin/age
          name: custom-tools
          subPath: age
        - mountPath: /usr/local/bin/kustomize
          name: custom-tools
          subPath: kustomize
        - mountPath: /age
          name: age-key

# The CMP plugin ConfigMap is part of this Helm release — no separate kubectl apply needed.
extraObjects:
  - apiVersion: v1
    kind: ConfigMap
    metadata:
      name: cmp-helm-sops-config
      namespace: argocd
    data:
      plugin.yaml: |
        apiVersion: argoproj.io/v1alpha1
        kind: ConfigManagementPlugin
        metadata:
          name: helm-sops
        spec:
          allowConcurrency: true
          # Only activates for apps that have *.enc.yaml encrypted secret files.
          # Apps without encrypted files use ArgoCD's built-in Helm support.
          discover:
            find:
              command:
                - sh
                - -c
                - |
                  # Activate for any source (Helm or Kustomize) that contains *.enc.yaml.
                  # The generate step below detects Chart.yaml vs kustomization.yaml
                  # and handles each case separately.
                  find . -name "*.enc.yaml" -maxdepth 2
          generate:
            command:
              - sh
              - -c
              - |
                set -e
                TMPDIR=$(mktemp -d)
                trap 'rm -rf $TMPDIR' EXIT

                if [ -f "Chart.yaml" ]; then
                  # Helm mode: decrypt values files and run helm template.
                  VALUES=""
                  for f in $(find . -maxdepth 1 \( -name 'values*.yaml' -o -name 'values*.enc.yaml' \) | sort); do
                    case "$f" in
                      *.enc.yaml)
                        OUT="$TMPDIR/$(basename ${f%%.enc.yaml}).yaml"
                        sops -d "$f" > "$OUT"
                        VALUES="$VALUES -f $OUT"
                        ;;
                      *)
                        VALUES="$VALUES -f $f"
                        ;;
                    esac
                  done
                  eval helm template "$ARGOCD_APP_NAME" \
                    --namespace "$ARGOCD_APP_NAMESPACE" \
                    --include-crds \
                    $VALUES \
                    .

                elif [ -f "kustomization.yaml" ]; then
                  # Kustomize mode: decrypt any *.enc.yaml resources in-place, then build.
                  # ArgoCD CMP clones are writable; relative paths (e.g. ../../../base) resolve
                  # correctly because the full repo is checked out.
                  for f in $(find . -maxdepth 1 -name '*.enc.yaml' | sort); do
                    dec="${f%.enc.yaml}.yaml"
                    sops -d "$f" > "$dec"
                    base_enc=$(basename "$f")
                    base_dec=$(basename "$dec")
                    sed -i "s|${base_enc}|${base_dec}|g" kustomization.yaml
                  done
                  kustomize build .

                else
                  # Raw manifest mode: decrypt all *.enc.yaml files and output them directly.
                  for f in $(find . -maxdepth 1 -name '*.enc.yaml' | sort); do
                    sops -d "$f"
                    printf '\n---\n'
                  done
                fi
          lockRepo: false
