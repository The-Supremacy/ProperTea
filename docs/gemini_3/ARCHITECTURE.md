# ProperTea - Technical Architecture

> **Version**: 5.0 (Environment-Centric)
> **Goal**: Modern Platform Engineering & Azure Parity.

## 1. Environment Strategy (The "4-Tier" Model)

We adhere to a strict "Environment > Layer" hierarchy. Local is for speed; SIT is for platform validation.

| Env      | Type       | Infrastructure             | Purpose                                                                 |
| :------- | :--------- | :------------------------- | :---------------------------------------------------------------------- |
| **DEV** | **Local** | **Docker Compose** | Inner-loop velocity. Isolated services.                                 |
| **SIT** | **Remote** | **Talos Linux** (Mini-PC)  | **The Lab.** Integration testing, GitOps (Flux), Infra validation.      |
| **UAT** | **Cloud** | **Azure AKS** | **The Mirror.** Cloud parity check, Azure Managed Services integration. |
| **PROD** | **Cloud** | **Azure AKS** | **The Real Deal.** Production traffic, High Availability.               |

---

## 2. Technical Stack

| Area          | Technology           | Implementation Details |
| :------------ |:---------------------| :--------------------- |
| **Identity** | **Authentik**        | **Local:** Docker container (Injected Blueprints via Volume).<br>**SIT/Cloud:** Helm Chart (Injected Blueprints via ConfigMap). |
| **Backend** | **.NET 10**          | Vertical Slice Architecture. Transport agnostic (RabbitMQ vs Azure Service Bus). |
| **Frontend** | **Next.js 16**       | BFF Pattern (Server Actions) + `next-auth` v5. |
| **Database** | **PostgreSQL 18**    | **Topology:** Two physical instances.<br>1. **Infra-DB:** For Authentik, Unleash, Infisical.<br>2. **App-DB:** For `propertea_org`, `propertea_comp` (1-Instance-Many-DBs). |
| **Storage** | **Code Abstraction** | **Pattern:** `IFileStorage` interface in .NET.<br>**SIT:** `S3Provider` -> **SeaweedFS** (Self-hosted S3).<br>**Cloud:** `AzureBlobProvider` -> **Azure Storage Account**. |
| **Secrets** | **Infisical**        | **SSOT.** Manages Secrets *and* App Configuration.<br>**Local:** CLI Injection.<br>**Cloud:** Operator -> K8s Secrets & Azure KeyVault Sync. |
| **Flags** | **Unleash**          | Self-hosted container. Controls feature rollouts without redeploying. |
| **AuthZ** | **OpenFGA**          | ReBAC (Relationship-Based Access Control). "Can User X view Document Y?" |
| **Observe** | **OpenTelemetry**    | **Collection:** OTel Collectors sidecar/daemonset.<br>**SIT:** OTel -> Loki/Tempo/Prometheus -> Grafana.<br>**Cloud:** OTel -> Azure Monitor. |

---

## 3. Tooling & Development

### A. Secrets Management (Infisical)
We do not commit `.env` files. Infisical acts as the single source of truth for both secrets (API Keys) and configuration (URLs).

* **Setup:** `brew install infisical`
* **Usage:** `infisical run -- docker-compose up`
* **Migration:** We migrate Authentik Blueprints to use `!Env [VAR_NAME]` tags, populated by Infisical at runtime.

### B. Local HTTPS (mkcert)
We use valid SSL certificates locally to support Secure Cookies.

* **Usage:** Traefik mounts certificates generated by `mkcert "*.propertea.localhost"`.

### C. Azure Emulation (Azurite)
Used strictly for local development when working on Azure-specific implementations (e.g., testing the `AzureBlobProvider`).

* **Role:** Provides a local Blob/Queue endpoint that matches Azure's API signature 100%.

### D. Platform Storage (SeaweedFS)
Used in SIT to provide an S3-compatible API for platform tools (Loki, Tempo, Postgres Backups) which require object storage.

* **Role:** Acts as the "S3 of the SIT Cluster."

---

## 4. System Architecture

### Tenant Resolution Flow

1.  **Request:** `https://acme.propertea.com` -> **Traefik** -> **Next.js BFF**.
2.  **Identification:** BFF checks Redis (App Instance) for slug `acme`. Resolves to GUID.
3.  **Propagation:** BFF adds header `X-Organization-Id: <GUID>` to downstream API calls.
4.  **Enforcement:** .NET Middleware reads header; sets `EF Core` Query Filter.

### SIT Cluster Topology (Talos)

* **Ingress:** Cloudflare Tunnel -> Traefik.
* **Persistence:**
    * **Postgres-Infra:** (StatefulSet) -> Local Disk.
    * **Postgres-App:** (CloudNativePG Operator) -> Local Disk + S3 Backups (SeaweedFS).
* **Observability:** OTel Collectors pushing to local Grafana Stack.

---

## 5. Diagram: The "Hybrid" Stack

```mermaid
graph TD
    subgraph "SIT (Talos Linux)"
        direction TB
        Traefik[Traefik]

        subgraph "Platform Layer"
            Infisical[Infisical Operator]
            Unleash[Unleash]
            Seaweed[SeaweedFS]
            PG_Infra[(Postgres Infra)]
        end

        subgraph "Application Layer"
            BFF[Next.js Portal]
            Backend[.NET Core]
            PG_App[(Postgres App)]
            Redis_App[(Redis App)]
        end
    end

    subgraph "External"
        Dev[Developer]
        Tunnel[Cloudflare Tunnel]
    end

    %% Flow
    Dev -- HTTPS --> Tunnel
    Tunnel --> Traefik
    Traefik --> BFF

    %% Config Injection
    Infisical -- "Injects Secrets" --> Backend
    Infisical -- "Injects Blueprints" --> PG_Infra

    %% App Flow
    BFF --> Backend
    Backend -- "EF Core" --> PG_App
    Backend -- "S3 SDK" --> Seaweed

    %% Dependencies
    Unleash -.-> PG_Infra
    Authentik -.-> PG_Infra
