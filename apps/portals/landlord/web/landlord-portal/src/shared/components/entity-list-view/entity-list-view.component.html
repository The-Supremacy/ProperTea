<div class="container mx-auto p-4 md:p-6">
  @if (config()) {
  <!-- Header -->
  @if (title()) {
    <div class="mb-6">
      <h1 class="text-3xl font-bold">{{ title() }}</h1>
    </div>
  }

  <!-- Toolbar -->
  <div class="mb-6">
    <div
      role="toolbar"
      class="flex flex-wrap items-center gap-2"
      [attr.aria-label]="title() + ' toolbar'">
      <!-- Left: Action Buttons -->
      @if (features().filters && config()!.filterConfig) {
        <hlm-sheet side="right">
          <button
            hlmSheetTrigger
            hlmBtn
            variant="outline"
            [size]="responsive.isMobile() ? 'icon' : 'default'">
            <app-icon name="filter_list" [size]="20" />
            <span class="hidden sm:inline">{{ 'common.filters' | transloco }}</span>
          </button>
          <hlm-sheet-content *hlmSheetPortal="let ctx" class="w-80">
            <hlm-sheet-header>
              <h3 hlmSheetTitle>{{ 'common.filters' | transloco }}</h3>
            </hlm-sheet-header>
            <div class="flex-1 overflow-y-auto p-4">
              <div class="space-y-4">
                @for (field of config()!.filterConfig!.fields; track field.key) {
                  <div>
                    <label hlmLabel [for]="field.key" class="mb-2">
                      {{ field.label | transloco }}
                    </label>

                    @switch (field.type) {
                      @case ('text') {
                        <input
                          [id]="field.key"
                          type="text"
                          [value]="filterValues()[field.key] || ''"
                          (input)="onFilterFieldChange(field.key, $any($event.target).value)"
                          [placeholder]="field.placeholder ? (field.placeholder | transloco) : ''"
                          hlmInput class="w-full" />
                      }
                      @case ('select') {
                        <app-async-select
                          [optionsProvider]="field.optionsProvider!"
                          [value]="$any(filterValues()[field.key] || '')"
                          [placeholder]="field.placeholder || 'Select...'"
                          (valueChange)="onFilterFieldChange(field.key, $event)" />
                      }
                      @case ('autocomplete') {
                        <app-autocomplete
                          [optionsProvider]="field.optionsProvider!"
                          [value]="$any(filterValues()[field.key] || '')"
                          [placeholder]="field.placeholder || 'common.search'"
                          [ariaLabel]="field.label"
                          (valueChange)="onFilterFieldChange(field.key, $event)" />
                      }
                      @case ('number') {
                        <input
                          [id]="field.key"
                          type="number"
                          [value]="filterValues()[field.key] || ''"
                          (input)="onFilterFieldChange(field.key, $any($event.target).value)"
                          [min]="field.min"
                          [max]="field.max"
                          hlmInput class="w-full" />
                      }
                      @case ('date') {
                        <input
                          [id]="field.key"
                          type="date"
                          [value]="filterValues()[field.key] || ''"
                          (input)="onFilterFieldChange(field.key, $any($event.target).value)"
                          hlmInput class="w-full" />
                      }
                      @case ('dateRange') {
                        <div class="flex flex-col gap-2">
                          <input
                            type="date"
                            [value]="$any(filterValues()[field.key])?.from || ''"
                            (input)="onFilterFieldChange(field.key, { ...$any(filterValues()[field.key]), from: $any($event.target).value })"
                            [placeholder]="'common.from' | transloco"
                            hlmInput class="w-full" />
                          <input
                            type="date"
                            [value]="$any(filterValues()[field.key])?.to || ''"
                            (input)="onFilterFieldChange(field.key, { ...$any(filterValues()[field.key]), to: $any($event.target).value })"
                            [placeholder]="'common.to' | transloco"
                            hlmInput class="w-full" />
                        </div>
                      }
                      @case ('boolean') {
                        <hlm-checkbox
                          [id]="$any(field.key)"
                          [checked]="!!filterValues()[field.key]"
                          (checkedChange)="onFilterFieldChange(field.key, $event)" />
                      }
                    }
                  </div>
                }
              </div>
            </div>
            <hlm-sheet-footer>
              <button hlmBtn variant="outline" class="flex-1" (click)="clearFilters()">
                {{ 'common.clearFilters' | transloco }}
              </button>
              <button hlmBtn class="flex-1" hlmSheetClose (click)="applyFilters()">
                {{ 'common.applyFilters' | transloco }}
              </button>
            </hlm-sheet-footer>
          </hlm-sheet-content>
        </hlm-sheet>
      }

      @if (features().columnSelection) {
        <hlm-sheet side="right">
          <button
            hlmSheetTrigger
            hlmBtn
            variant="outline"
            [size]="responsive.isMobile() ? 'icon' : 'default'">
            <app-icon name="view_column" [size]="20" />
            <span class="hidden sm:inline">{{ 'common.columns' | transloco }}</span>
          </button>
          <hlm-sheet-content *hlmSheetPortal="let ctx" class="w-80">
            <hlm-sheet-header>
              <h3 hlmSheetTitle>{{ 'common.columns' | transloco }}</h3>
            </hlm-sheet-header>
            <div class="flex-1 overflow-y-auto p-4">
              <div class="space-y-2">
                @for (column of table.getAllLeafColumns(); track column.id) {
                  @if (column.id !== 'actions') {
                    <label class="flex cursor-pointer items-center justify-between p-2 rounded-md hover:bg-accent">
                      <span class="text-sm">{{ column.columnDef.header }}</span>
                      <hlm-checkbox
                        [checked]="column.getIsVisible()"
                        (checkedChange)="column.toggleVisibility()" />
                    </label>
                  }
                }
              </div>
            </div>
            <hlm-sheet-footer>
              <button hlmBtn variant="outline" class="flex-1" (click)="resetColumnVisibility()">
                {{ 'common.reset' | transloco }}
              </button>
              <button hlmBtn class="flex-1" hlmSheetClose>
                {{ 'common.done' | transloco }}
              </button>
            </hlm-sheet-footer>
          </hlm-sheet-content>
        </hlm-sheet>
      }

      @if (features().refresh) {
        <button
          hlmBtn
          variant="outline"
          size="icon"
          (click)="refresh()"
          [disabled]="state.loading"
          [title]="'common.refresh' | transloco">
          <app-icon name="refresh" [size]="20" [class.animate-spin]="state.loading" />
        </button>
      }

      <!-- Search (Inline on Desktop, Expandable on Mobile) -->
      @if (features().search) {
        <!-- Mobile: Search Icon Button -->
        <button
          hlmBtn
          variant="outline"
          size="icon"
          (click)="searchExpanded.set(!searchExpanded())"
          class="md:hidden"
          [title]="'common.search' | transloco">
          <app-icon [name]="searchExpanded() ? 'close' : 'search'" [size]="20" />
        </button>

        <!-- Desktop: Inline Search Input -->
        <div class="relative hidden md:block md:w-64">
          <app-icon
            name="search"
            [size]="20"
            class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground" />
          <input
            type="text"
            [value]="globalFilter()"
            (input)="onTableSearchChange($any($event.target).value)"
            [placeholder]="'common.search' | transloco"
            hlmInput class="w-full pl-10 pr-10" />
          @if (globalFilter()) {
            <button
              type="button"
              (click)="clearTableSearch()"
              class="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground">
              <app-icon name="close" [size]="16" />
            </button>
          }
        </div>
      }

      <!-- Spacer to push right-aligned items -->
      <div class="flex-1"></div>

      <!-- Right: Table Menu + Create Button -->
      @if (config()!.tableActions && config()!.tableActions!.length > 0) {
        <button
          [hlmDropdownMenuTrigger]="tableActionsMenu"
          hlmBtn
          variant="outline"
          size="icon">
          <app-icon name="more_vert" [size]="20" />
        </button>

        <ng-template #tableActionsMenu>
          <div hlmDropdownMenu class="min-w-48">
            @for (action of config()!.tableActions; track action.label; let idx = $index) {
              @if (action.separatorBefore && idx > 0) {
                <div hlmDropdownMenuSeparator></div>
              }
              <button
                hlmDropdownMenuItem
                [variant]="action.variant === 'destructive' ? 'destructive' : 'default'"
                (click)="handleTableAction(action)">
                <app-icon [name]="action.icon" [size]="16" />
                <span>{{ action.label | transloco }}</span>
              </button>
            }
          </div>
        </ng-template>
      }

      @if (features().create) {
        @if (createRoute()) {
          <a
            [routerLink]="createRoute()"
            hlmBtn
            [size]="responsive.isMobile() ? 'icon' : 'default'"
            [attr.aria-label]="createLabel() | transloco">
            <app-icon name="add" [size]="20" />
            <span class="hidden sm:inline">{{ createLabel() | transloco }}</span>
          </a>
        } @else {
          <button
            hlmBtn
            type="button"
            [size]="responsive.isMobile() ? 'icon' : 'default'"
            (click)="createClick.emit()"
            [attr.aria-label]="createLabel() | transloco">
            <app-icon name="add" [size]="20" />
            <span class="hidden sm:inline">{{ createLabel() | transloco }}</span>
          </button>
        }
      }
    </div>

    <!-- Mobile: Expanded Search Input -->
    @if (features().search && searchExpanded()) {
      <div class="mt-2 md:hidden">
        <div class="relative">
          <app-icon
            name="search"
            [size]="20"
            class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground" />
          <input
            type="text"
            [value]="globalFilter()"
            (input)="onTableSearchChange($any($event.target).value)"
            [placeholder]="'common.search' | transloco"
            hlmInput class="w-full pl-10 pr-10" />
          @if (globalFilter()) {
            <button
              type="button"
              (click)="clearTableSearch()"
              class="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground">
              <app-icon name="close" [size]="16" />
            </button>
          }
        </div>
      </div>
    }
  </div>

  <!-- Data Display Container with Loading Overlay -->
  <div class="relative">
    <!-- Reload Overlay (only when reloading with existing data) -->
    @if (state.loading && state.hasData) {
      <div
        class="absolute inset-0 z-10 flex items-center justify-center rounded-lg bg-background/80 backdrop-blur-sm">
        <hlm-spinner size="lg" />
      </div>
    }

    <!-- Skeleton Loading (initial load, no data yet) -->
    @if (state.loading && !state.hasData) {
      @if (!responsive.isMobile()) {
        <div class="rounded-lg border">
          <div class="bg-muted/50 flex gap-4 border-b px-4 py-3">
            <hlm-skeleton class="h-4 w-24" />
            <hlm-skeleton class="h-4 w-32" />
            <hlm-skeleton class="h-4 w-20" />
            <hlm-skeleton class="h-4 w-28" />
          </div>
          @for (_ of [1, 2, 3, 4, 5]; track $index) {
            <div class="flex items-center gap-4 border-b px-4 py-4 last:border-b-0">
              <hlm-skeleton class="h-4 w-24" />
              <hlm-skeleton class="h-4 w-40" />
              <hlm-skeleton class="h-4 w-16" />
              <hlm-skeleton class="h-4 w-32" />
            </div>
          }
        </div>
      } @else {
        <div class="space-y-4">
          @for (_ of [1, 2, 3]; track $index) {
            <div class="rounded-lg border p-4 space-y-3">
              <hlm-skeleton class="h-4 w-3/4" />
              <hlm-skeleton class="h-4 w-1/2" />
              <hlm-skeleton class="h-4 w-1/3" />
            </div>
          }
        </div>
      }
    }

    <!-- Empty State -->
    @if (state.isEmpty) {
      <div hlmEmpty class="my-6 rounded-lg border">
        <div hlmEmptyHeader>
          <div hlmEmptyMedia variant="icon">
            <app-icon
              [name]="config()!.emptyState?.icon || 'inbox'"
              [size]="48" />
          </div>
          <div hlmEmptyTitle>
            {{ config()!.emptyState?.title || 'No results found' }}
          </div>
          <div hlmEmptyDescription>
            {{ config()!.emptyState?.description || 'Try adjusting your filters' }}
          </div>
        </div>
      </div>
    }

    <!-- Desktop Table View -->
    @if (!responsive.isMobile() && state.hasData) {
      <div hlmTableContainer class="rounded-lg border">
        <table hlmTable>
          <thead hlmTHead>
            @for (headerGroup of table.getHeaderGroups(); track headerGroup.id) {
              <tr hlmTr class="bg-muted/50">
                @for (header of headerGroup.headers; track header.id) {
                  <th hlmTh
                    [class.cursor-pointer]="header.column.getCanSort()"
                    (click)="header.column.getToggleSortingHandler()?.($event)">
                    <div class="flex items-center gap-1 font-semibold">
                      <ng-container
                        *flexRender="header.column.columnDef.header; props: header.getContext(); let headerText">
                        <span [innerHTML]="headerText"></span>
                      </ng-container>
                      @if (header.column.getCanSort()) {
                        <app-icon [name]="getSortIcon(header.column.id)" [size]="16" />
                      }
                    </div>
                  </th>
                }
                @if (config()!.actions && config()!.actions!.length > 0) {
                  <th hlmTh class="text-right">
                    <span class="font-semibold">{{ 'common.actions' | transloco }}</span>
                  </th>
                }
              </tr>
            }
          </thead>
          <tbody hlmTBody>
            @for (row of table.getRowModel().rows; track getEntityId(row.original)) {
              <tr
                hlmTr
                class="cursor-pointer"
                (click)="onRowClick(row.original)">
                @for (cell of row.getVisibleCells(); track cell.id) {
                  <td hlmTd>
                    <ng-container
                      *flexRender="cell.column.columnDef.cell; props: cell.getContext(); let cellContent">
                      <div [innerHTML]="cellContent"></div>
                    </ng-container>
                  </td>
                }
                @if (config()!.actions && config()!.actions!.length > 0) {
                  <td hlmTd class="text-right">
                    <div class="flex justify-end">
                      <button
                        hlmBtn
                        variant="ghost"
                        size="icon"
                        [hlmDropdownMenuTrigger]="rowActionsMenu"
                        (click)="$event.stopPropagation()">
                        <app-icon name="more_vert" [size]="20" />
                      </button>

                      <ng-template #rowActionsMenu>
                        <div hlmDropdownMenu class="min-w-32">
                          @for (action of config()!.actions; track action.label; let idx = $index) {
                            @if (shouldShowAction(action, row.original)) {
                              @if (action.separatorBefore && idx > 0) {
                                <div hlmDropdownMenuSeparator></div>
                              }
                              <button
                                hlmDropdownMenuItem
                                [variant]="action.variant === 'destructive' ? 'destructive' : 'default'"
                                (click)="handleAction(action, row.original)">
                                <app-icon [name]="action.icon" [size]="16" />
                                <span>{{ action.label | transloco }}</span>
                              </button>
                            }
                          }
                        </div>
                      </ng-template>
                    </div>
                  </td>
                }
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Mobile Card View -->
    @if (responsive.isMobile() && state.hasData) {
      <div class="space-y-4">
        @for (row of table.getRowModel().rows; track getEntityId(row.original)) {
          <section
            hlmCard
            class="cursor-pointer transition-shadow hover:shadow-md"
            (click)="onRowClick(row.original)">
            <!-- Default mobile card layout -->
            <div class="space-y-2">
              @for (cell of row.getVisibleCells(); track cell.id) {
                <div class="flex items-start justify-between">
                  <span class="text-sm font-medium text-muted-foreground">{{ $any(cell.column.columnDef.header) }}:</span>
                  <div class="text-sm">
                    <ng-container
                      *flexRender="cell.column.columnDef.cell; props: cell.getContext(); let cellContent">
                      <div [innerHTML]="cellContent"></div>
                    </ng-container>
                  </div>
                </div>
              }
            </div>

            <!-- Mobile Actions -->
            @if (config()!.actions && config()!.actions!.length > 0) {
              <div class="mt-3 flex justify-end border-t pt-3">
                <button
                  hlmBtn
                  variant="ghost"
                  size="icon"
                  [hlmDropdownMenuTrigger]="mobileRowActionsMenu"
                  (click)="$event.stopPropagation()">
                  <app-icon name="more_vert" [size]="20" />
                </button>

                <ng-template #mobileRowActionsMenu>
                  <div hlmDropdownMenu class="min-w-32">
                    @for (action of config()!.actions; track action.label; let idx = $index) {
                      @if (shouldShowAction(action, row.original)) {
                        @if (action.separatorBefore && idx > 0) {
                          <div hlmDropdownMenuSeparator></div>
                        }
                        <button
                          hlmDropdownMenuItem
                          [variant]="action.variant === 'destructive' ? 'destructive' : 'default'"
                          (click)="handleAction(action, row.original)">
                          <app-icon [name]="action.icon" [size]="16" />
                          <span>{{ action.label | transloco }}</span>
                        </button>
                      }
                    }
                  </div>
                </ng-template>
              </div>
            }
          </section>
        }
      </div>
    }
  </div>

  <!-- Pagination -->
  @if (state.hasData) {
    <hlm-numbered-pagination
      [currentPage]="state.pagination.page"
      (currentPageChange)="onPageChange($event)"
      [itemsPerPage]="state.pagination.pageSize"
      (itemsPerPageChange)="onPageSizeChange($event)"
      [totalItems]="state.totalCount"
      [pageSizes]="[10, 20, 50]" />
  }
  }
</div>
