version: 1
metadata:
    name: ProperTea - Recovery
entries:
    # --- Stages ---
    - model: authentik_stages_identification.identificationstage
      id: propertea-stage-recovery-ident
      identifiers:
          name: ProperTea - Recovery Identification
      attrs:
          user_fields: [email]
          case_insensitive_matching: true
          show_matched_user: false

    - model: authentik_stages_email.emailstage
      id: propertea-stage-recovery-email
      identifiers:
          name: ProperTea - Recovery Email
      attrs:
          use_global_settings: true
          template: email/password_reset.html
          subject: "Reset your ProperTea password"
          activate_user_on_success: true

    - model: authentik_stages_prompt.promptstage
      id: propertea-stage-recovery-prompt
      identifiers:
          name: ProperTea - Recovery Password Prompt
      attrs:
          fields:
              - !Find [authentik_stages_prompt.prompt, [field_key, "password"]]
              - !Find [authentik_stages_prompt.prompt, [field_key, "password_repeat"]]
          validation_policies:
              - !Find [authentik_policies_password.passwordpolicy, [name, "ProperTea - Password policy"]]

    - model: authentik_stages_user_write.userwritestage
      id: propertea-stage-recovery-write
      identifiers:
          name: ProperTea - Write New Password
      attrs:
          user_creation_mode: never_create

    # --- Flow ---
    - model: authentik_flows.flow
      id: propertea-flow-recovery
      identifiers:
          slug: propertea-flow-recovery
      attrs:
          name: ProperTea Password Recovery
          title: Reset your password
          designation: recovery

    # --- Bindings ---
    - model: authentik_flows.flowstagebinding
      identifiers:
          target: !KeyOf propertea-flow-recovery
          stage: !KeyOf propertea-stage-recovery-ident
      attrs:
          order: 10

    - model: authentik_flows.flowstagebinding
      identifiers:
          target: !KeyOf propertea-flow-recovery
          stage: !KeyOf propertea-stage-recovery-email
      attrs:
          order: 20

    - model: authentik_flows.flowstagebinding
      identifiers:
          target: !KeyOf propertea-flow-recovery
          stage: !KeyOf propertea-stage-recovery-prompt
      attrs:
          order: 30
          invalid_response_action: retry

    - model: authentik_flows.flowstagebinding
      identifiers:
          target: !KeyOf propertea-flow-recovery
          stage: !KeyOf propertea-stage-recovery-write
      attrs:
          order: 40

    - model: authentik_flows.flowstagebinding
      identifiers:
          target: !KeyOf propertea-flow-recovery
          stage: !Find [authentik_stages_user_login.userloginstage, [name, "ProperTea - Immediate Login"]]
      attrs:
          order: 50
